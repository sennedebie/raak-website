{% extends "admin/base.html" %} {% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/admin/manage_roles.css') }}"
/>
{% endblock %} {% block title %} Rollen beheren {% endblock %} {% block content
%}

<div class="table-tile">
  <h1>Rollen beheren</h1>
  <div class="header-container">
    <div class="role-name"></div>
    <div class="role-actions">
      <form
        action="{{ url_for('add_role') }}"
        method="get"
        style="display: inline"
      >
        <button type="submit" class="icon-btn" title="Rol toevoegen">
          <i class="fa-solid fa-shield"></i> Rol toevoegen
        </button>
      </form>
    </div>
  </div>
  <table>
    <tr>
      <th>Rol</th>
      <th>Beschrijving</th>
      <th>Gemaakt op</th>
      <th>Gemaakt door</th>
      <th>Acties</th>
    </tr>
    {% if roles %} {% for role in roles %}
    <tr>
      <td>{{ role.name|capitalize }}</td>

      <td class="role-description">{{ role.description }}</td>

      <td>
        {{
        role.created_at.astimezone(zoneinfo.ZoneInfo('Europe/Brussels')).strftime('%Y-%m-%d
        %H:%M') if role.created_at else '' }} }}
      </td>
      <td>{{ role.created_by_username }}</td>

      <td>
        <form action="#" method="post" style="display: inline">
          <button type="submit" class="icon-btn" title="Rol bewerken">
            <i class="fa-solid fa-pen-to-square"></i>
          </button>
        </form>
        <form
          action="{{ url_for('delete_role', role_id=role.id) }}"
          method="post"
          style="display: inline"
          onsubmit="return confirm('Ben je zeker dat je de rol {{ role.name }} wil verwijderen?');"
        >
          <button type="submit" class="icon-btn" title="Rol verwijderen">
            <i class="fa-solid fa-trash"></i>
          </button>
        </form>
      </td>
    </tr>
    {% endfor %} {% else %}
    <tr>
      <td colspan="7" class="empty-row">Er zijn geen rollen gedefinieerd</td>
    </tr>
    {% endif %}
  </table>
</div>

<div class="table-tile">
  <h1>Overzichtstabel</h1>

  <table class="overview">
    <tr>
      <th>Gebruiker</th>
      {% for role in roles %}
      <th>{{ role.name|capitalize }}</th>
      {% endfor %}
    </tr>
    {% for user in all_users %}
    <tr>
      <td>{{ user.username }}</td>
      {% for role in roles %}
      <td class="centered-cell">
        {% set users = users_by_role.get(role.id, []) %} {% if
        users|selectattr('user_id', 'equalto', user.id)|list %} &#10004; {%
        endif %}
      </td>
      {% endfor %}
    </tr>
    {% endfor %}
  </table>
</div>

<div class="table-tile">
  <h1>Roltoewijzing</h1>
  {% for role in roles %}
  <div class="role-group">
    <div class="header-container">
      <div class="role-name">
        <h2 class="inline-header">{{ role.name|capitalize }}</h2>
      </div>
      <div class="role-actions">
        <form action="#" method="get" style="display: inline">
          <button
            type="button"
            class="icon-btn"
            title="Gebruiker toevoegen aan rol"
            onclick="openModal('{{ role.id }}')"
          >
            <i class="fa-solid fa-user-plus"></i> Gebruiker toevoegen
          </button>
        </form>
      </div>
    </div>
    <table>
      <tr>
        <th>Gebruiker</th>
        <th>Toegewezen op</th>
        <th>Toegewezen door</th>
        <th>Acties</th>
      </tr>
      {% set users = users_by_role.get(role.id, []) %} {% if users %} {% for
      user in users %}
      <tr>
        <td>{{ user.username }}</td>
        <td>
          {{
          user.created_at.astimezone(zoneinfo.ZoneInfo('Europe/Brussels')).strftime('%Y-%m-%d
          %H:%M') if user.created_at else '' }}
        </td>
        <td>{{ user.created_by_username }}</td>

        <td>
          <form
            action="{{ url_for('revoke_role', user_id=user.user_id, role_id=role.id) }}"
            method="post"
            style="display: inline"
            onsubmit="return confirm('Weet je zeker dat je deze rol wilt intrekken bij gebruiker {{ user.username }} ?');"
          >
            <button type="submit" class="icon-btn" title="Rol intrekken">
              <i class="fa-solid fa-user-minus"></i>
            </button>
          </form>
        </td>
      </tr>
      {% endfor %} {% else %}
      <tr>
        <td colspan="7" class="empty-row">Geen gebruikers met deze rol.</td>
      </tr>
      {% endif %}
    </table>
  </div>

  <!-- Modal for adding user to role -->
  <div id="addUserModal-{{ role.id }}" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('{{ role.id }}')">&times;</span>
      <h3>Gebruiker toevoegen aan rol: {{ role.name|capitalize }}</h3>
      <form
        action="{{ url_for('assign_role', role_id=role.id) }}"
        method="post"
      >
        <label for="user_id_{{ role.id }}">Selecteer gebruiker:</label>
        <select name="user_id" id="user_id_{{ role.id }}">
          {% for user in all_users %}
          <option value="{{ user.id }}">
            {{ user.username }} ({{ user.first_name }} {{ user.last_name }})
          </option>
          {% endfor %}
        </select>
        <button type="submit" class="icon-btn">
          <i class="fa-solid fa-user-plus"></i> Toevoegen
        </button>
      </form>
    </div>
  </div>
  {% endfor %}
</div>

<script>
  function openModal(roleId) {
    document.getElementById("addUserModal-" + roleId).style.display = "block";
  }
  function closeModal(roleId) {
    document.getElementById("addUserModal-" + roleId).style.display = "none";
  }
  // Optional: close modal when clicking outside
  window.onclick = function (event) {
    document.querySelectorAll(".modal").forEach(function (modal) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    });
  };
</script>

{% endblock %}
